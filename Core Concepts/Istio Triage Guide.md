# Istio Triage Guide

## Functional Components
| Component Name | Responsibilities | Platform | Sample Configuration |
| ------ | ------ | ------ | ------ |
| IstioD | IstioD provides service discovery, configuration and certificate management| Control plane/ Data plane | NA
Istio Ingress Gateway | A loadbalancer (Standalone Envoy Proxy) operating at the edge of the mesh that receives incoming HTTPS/TCP traffics | Control Plane | NA
Gateway | Gateway sits at the edge of the mesh and receives all the incoming connections on the behalf of the PODs. The Istio Ingress Gateway also provide option of _SSL Termination_ at the Gateway level.Terminating SSL connection at the Gateway level helps in offloading the computing task to decrypt traffic from the application leve, which improves apllication performance. PostSSL termination at the Gateway, traffic will be encrypted and decrypted back again using Istio mTLS capabilities. For Service to Service authentication as well, Istio mTLS ensures traffic is encrypted on transit between services and CITADEL in control plane, and it is responsible for issuing and managing certificates. <br/><br/>**Note** : Make sure to use only one Gateway for one namespace to avoid the Internal Server Errors | Control Plane | [GW]()
Virtual Service and Destination Rule | While the VirualService defines configuration affecting the traffic routing, a DestinationRule defines policies that apply to traffic intended for a service after routing has occured. The resources are tightly linked, and first DestinationRules will be applied before updating VirtualService so as to avoid unintentional traffic flow. For instance, when introducing a newer version of service, define the DestinationRule subset with rules for whatwill reach that service before introducing the VirtualService to route traffic to it. | Control Plane | [VS]()
Service  | As Kubernetes resolves DNS on a cluster basis and because the DNS resolution is tied to the cluster, service object in every cluster will be defined where a client runs, regardless of the location of the service's endpoints. For ensuring this, duplication of the service object of to every cluster using _kubectl_  will be performed. Duplication ensures Kubernetes can resolve the service name in any cluster. Since the service objects are defined in a namespace and needs to be included in the service definations in all clusters. <br/><br/>**Note** : The name of the service should match with the name of _http.destination.host_ of the VirtualService | Workload Cluster | [SERVICE]()
Service Entry | All outbound traffic from an Istio-enabled Pod is redirected to its Sidecar Proxy by default, accessibility of URLs outside of the cluster depends on the configuration of the proxy. By default Istio configures the Envoy proxy to pass through the requests for unknown services, so for a controlled way of enabling access to external services, the meshConfig.outboundTrafficPolicy.mode need to be configured to the REGISTRY_ONLY mode. To access external services, ServiceEntry would be configured to provide controlled access to external services. This will help in stopping egress leaking. <br/><br/>**Note** : For Pods accessing external services which are out of the ServiceMesh, the ServiceEntry has to be created and deployed.<br/><br/>**Troubleshooting**<br/>To check whether a Pod is able to connect to downstream service <br/><br/>1. Make a request to the external HTTPS service from the _SOURCE POD_ and see the response, if the response is _200 OK_ then downstream connectivity is working fine <br/>`kubectl exec -it pod/<source pod name> -c sleep -- curl -I https://vault.com` ,br/> `200 OK`<br/><br/>2. If the response is not _200_, and you are getting something like _Connection Reset by Peer_ or _400_, _401_, _500_ ERROR. Then the first step is to check the Istio Proxy Logs in the Istio Proxy Container<br/>`kubectl logs pod/<source pod> -c istio-proxy -f -n <namespace> <br/><br/>If the _BLACKHOLE CLUSTER_ problem is there in the log that means the ServiceEntry is wrongly configured which is not allowing the Istio proxy to to route the egress traffic to the desired endpoint<br/><br/>Possible Reasons for This Error:<br/>1.Desired downstream endpoint CIDR is wrong<br/>2. Mismatch in the name and protocol<br/>3.CIDR used in two serviceentries are overlapping. In this situation always use _HOSTNAMES_ of the endpoints and remove CIDR, also change RESOLUTION to DNS | Control Plane | [SE]()
